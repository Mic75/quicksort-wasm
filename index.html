<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title></title>
</head>
<body>

<script src="./input-generator.js"></script>
<script type="module">

  import quicksort from "./quicksort.js";
  import MonoQSortWasm from "./mono-quicksort-wasm.js";

  console.log("Generating input data");
  let time;

  console.log("Starting benchmark\n\n");

  // builtin Ecmascript sort
  console.log("Builtin Ecmascript sort");

  let unsortedCopy = unsorted.slice();
  time = Date.now();
  unsortedCopy.sort();
  console.log(`500,000 entries sorted in ${Date.now() - time}ms`);

  console.log("\n");

  // Pure JS Lomuto quicksort
  console.log("Monothreaded Lomuto Quicksort, pure JS");

  unsortedCopy = unsorted.slice();
  time = Date.now();
  quicksort(unsortedCopy, 0, unsortedCopy.length - 1);
  console.log(`500,000 entries sorted in ${Date.now() - time}ms`);

  console.log("\n");

  // WebAssembly Lomuto quicksort
  MonoQSortWasm().then(wasm => {
    console.log("Monothreaded Lomuto Quicksort, WebAssembly");

    function callWasm(array) {
      const heapBuf = wasm._malloc(array.length * Uint32Array.BYTES_PER_ELEMENT);
      const heap32Offset =  heapBuf / 4;
      wasm.HEAP32.set(array, heap32Offset);
      wasm.ccall('quicksort', null, ['number', 'number', 'number'], [heapBuf, 0, array.length - 1]);
      // console.log(wasm.HEAP32.subarray(heap32Offset, heap32Offset + array.length));
      wasm._free(heapBuf);
    }
    callWasm(unsorted.slice());
  });

  // we wait a little before loading multi-threaded version, for log comfort
  setTimeout(() => {
    ['multhreaded-quicksort.js', 'threaded-quicksort-wasm.js'].forEach((fileName) => {
      const script = document.createElement('script');
      script.type = "text/javascript";
      script.src = fileName;
      document.body.appendChild(script);
    });
  }, 500);


</script>
</body>
</html>
